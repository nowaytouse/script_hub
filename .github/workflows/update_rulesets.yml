name: Update Rulesets

on:
  schedule:
    - cron: '0 4 * * *'  # Runs at 04:00 UTC everyday
  workflow_dispatch:      # Allows manual run

jobs:
  update-rules:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0  # å®Œæ•´åŽ†å²ç”¨äºŽgitæ“ä½œ
        
    - name: Configure Git
      run: |
        git config --global user.name "GitHub Action"
        git config --global user.email "action@github.com"

    - name: Install sing-box (for SRS generation)
      run: |
        # ä¸‹è½½æœ€æ–°sing-box
        SINGBOX_VERSION=$(curl -s https://api.github.com/repos/SagerNet/sing-box/releases/latest | grep '"tag_name"' | sed -E 's/.*"v([^"]+)".*/\1/')
        echo "Installing sing-box v${SINGBOX_VERSION}"
        curl -Lo sing-box.tar.gz "https://github.com/SagerNet/sing-box/releases/download/v${SINGBOX_VERSION}/sing-box-${SINGBOX_VERSION}-linux-amd64.tar.gz"
        tar -xzf sing-box.tar.gz
        sudo mv sing-box-${SINGBOX_VERSION}-linux-amd64/sing-box /usr/local/bin/
        rm -rf sing-box.tar.gz sing-box-${SINGBOX_VERSION}-linux-amd64
        sing-box version
        
    - name: Execute Full Update Script (Unattended Mode)
      run: |
        chmod +x merge_sync/*.sh
        ./merge_sync/full_update.sh --unattended --verbose
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Summary
      run: |
        echo "## ðŸ“Š Update Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Category | Count |" >> $GITHUB_STEP_SUMMARY
        echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
        echo "| MetaCubeX Rules | $(ls ruleset/MetaCubeX/*.list 2>/dev/null | wc -l) |" >> $GITHUB_STEP_SUMMARY
        echo "| Surge Rules | $(ls ruleset/Surge\(Shadowkroket\)/*.list 2>/dev/null | wc -l) |" >> $GITHUB_STEP_SUMMARY
        echo "| SingBox SRS | $(ls ruleset/SingBox/*.srs 2>/dev/null | wc -l) |" >> $GITHUB_STEP_SUMMARY
        echo "| Sources Files | $(ls ruleset/Sources/Links/*_sources.txt 2>/dev/null | wc -l) |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        if [ -f "ruleset/Surge(Shadowkroket)/AdBlock_Merged.list" ]; then
          ADBLOCK_COUNT=$(grep -v "^#" "ruleset/Surge(Shadowkroket)/AdBlock_Merged.list" | grep -v "^$" | wc -l)
          echo "**AdBlock Rules:** ${ADBLOCK_COUNT}" >> $GITHUB_STEP_SUMMARY
        fi
