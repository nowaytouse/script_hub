name: Update Rulesets

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# GitHub Actions Workflow - è§„åˆ™é›†è‡ªåŠ¨æ›´æ–°
# 
# åŠŸèƒ½èŒƒå›´ (CI/CD ä¸“ç”¨):
#   âœ… è§„åˆ™é›†æ›´æ–° (ä»Žä¸Šæ¸¸æºä¸‹è½½å’Œåˆå¹¶)
#   âœ… æ™ºèƒ½åŽ»é‡ (å¹¿å‘Š > ç»†åˆ† > å…œåº•)
#   âœ… ç©ºè§„åˆ™é›†æ¸…ç†
#   âœ… ç«¯å£è§„åˆ™åŒæ­¥åˆ°é˜²ç«å¢™æ¨¡å—
#   âœ… å¹¿å‘Šæ¨¡å—åˆå¹¶
#   âœ… SRS æ–‡ä»¶ç”Ÿæˆ (Sing-box)
#   âœ… Git æäº¤å’ŒæŽ¨é€
#
# ä¸æ‰§è¡Œçš„æ“ä½œ (æœ¬åœ°ä¸“ç”¨):
#   âŒ ä¸å»ºç«‹å¤‡ä»½ (CI=true è‡ªåŠ¨è·³è¿‡)
#   âŒ ä¸æ›´æ–°å†…æ ¸ (--unattended è·³è¿‡)
#   âŒ ä¸ä¸‹è½½ Singbox é…ç½® (--unattended è·³è¿‡)
#   âŒ ä¸åŒæ­¥åˆ° iCloud (--unattended è·³è¿‡)
#   âŒ ä¸åŒæ­¥ Surge é…ç½® (--unattended è·³è¿‡)
#
# è¿è¡Œæ—¶é—´: æ¯å¤© UTC 04:00 (åŒ—äº¬æ—¶é—´ 12:00)
# æ‰‹åŠ¨è§¦å‘: workflow_dispatch
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

on:
  schedule:
    - cron: '0 4 * * *'  # Runs at 04:00 UTC everyday (12:00 Beijing Time)
  workflow_dispatch:      # Allows manual run

jobs:
  update-rules:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0  # å®Œæ•´åŽ†å²ç”¨äºŽgitæ“ä½œ
        
    - name: Configure Git
      run: |
        git config --global user.name "GitHub Action"
        git config --global user.email "action@github.com"

    - name: Install sing-box (for SRS generation only)
      run: |
        # ä»…å®‰è£… sing-box å‘½ä»¤è¡Œå·¥å…·ç”¨äºŽ SRS æ–‡ä»¶ç”Ÿæˆ
        # ä¸ä¸‹è½½ Singbox é…ç½®æ–‡ä»¶ (ç”± --unattended æ¨¡å¼è·³è¿‡)
        SINGBOX_VERSION=$(curl -s https://api.github.com/repos/SagerNet/sing-box/releases/latest | grep '"tag_name"' | sed -E 's/.*"v([^"]+)".*/\1/')
        echo "Installing sing-box v${SINGBOX_VERSION} (CLI tool only)"
        curl -Lo sing-box.tar.gz "https://github.com/SagerNet/sing-box/releases/download/v${SINGBOX_VERSION}/sing-box-${SINGBOX_VERSION}-linux-amd64.tar.gz"
        tar -xzf sing-box.tar.gz
        sudo mv sing-box-${SINGBOX_VERSION}-linux-amd64/sing-box /usr/local/bin/
        rm -rf sing-box.tar.gz sing-box-${SINGBOX_VERSION}-linux-amd64
        sing-box version
        
    - name: Execute Full Update Script (Unattended Mode)
      run: |
        chmod +x merge_sync/*.sh
        # --unattended æ¨¡å¼:
        #   âœ… å¯ç”¨ Git æ“ä½œ (pull/push)
        #   âœ… è§„åˆ™é›†æ›´æ–°å’Œåˆå¹¶
        #   âœ… æ™ºèƒ½åŽ»é‡å’Œæ¸…ç†
        #   âœ… ç«¯å£è§„åˆ™åŒæ­¥åˆ°é˜²ç«å¢™æ¨¡å—
        #   âœ… SRS æ–‡ä»¶ç”Ÿæˆ
        #   âŒ è·³è¿‡æ ¸å¿ƒæ›´æ–° (WITH_CORE=false)
        #   âŒ è·³è¿‡ iCloud åŒæ­¥ (SKIP_MODULE=true)
        #   âŒ è·³è¿‡ Surge é…ç½®åŒæ­¥ (SKIP_PROFILE=true)
        # CI=true çŽ¯å¢ƒå˜é‡:
        #   âŒ æ‰€æœ‰è„šæœ¬è‡ªåŠ¨è·³è¿‡å¤‡ä»½
        ./merge_sync/full_update.sh --unattended --verbose
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        CI: true  # è‡ªåŠ¨è·³è¿‡æ‰€æœ‰å¤‡ä»½æ“ä½œ
        
    - name: Summary
      run: |
        echo "## ðŸ“Š Update Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“ File Statistics" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Category | Count |" >> $GITHUB_STEP_SUMMARY
        echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
        echo "| MetaCubeX Rules | $(ls ruleset/MetaCubeX/*.list 2>/dev/null | wc -l) |" >> $GITHUB_STEP_SUMMARY
        echo "| Surge Rules | $(ls ruleset/Surge\(Shadowkroket\)/*.list 2>/dev/null | wc -l) |" >> $GITHUB_STEP_SUMMARY
        echo "| SingBox SRS | $(ls ruleset/SingBox/*.srs 2>/dev/null | wc -l) |" >> $GITHUB_STEP_SUMMARY
        echo "| Sources Files | $(ls ruleset/Sources/Links/*_sources.txt 2>/dev/null | wc -l) |" >> $GITHUB_STEP_SUMMARY
        echo "| Modules | $(ls module/surge\(main\)/*.sgmodule 2>/dev/null | wc -l) |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ”‘ Key Rulesets" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        if [ -f "ruleset/Surge(Shadowkroket)/AdBlock.list" ]; then
          ADBLOCK_COUNT=$(grep -cv "^#\|^$" "ruleset/Surge(Shadowkroket)/AdBlock.list" 2>/dev/null || echo "0")
          echo "- **AdBlock** (å¹¿å‘Šæ‹¦æˆª): ${ADBLOCK_COUNT} rules" >> $GITHUB_STEP_SUMMARY
        fi
        if [ -f "ruleset/Surge(Shadowkroket)/ChinaDirect.list" ]; then
          CHINADIRECT_COUNT=$(grep -cv "^#\|^$" "ruleset/Surge(Shadowkroket)/ChinaDirect.list" 2>/dev/null || echo "0")
          echo "- **ChinaDirect** (DNSé˜²æ³„æ¼): ${CHINADIRECT_COUNT} rules" >> $GITHUB_STEP_SUMMARY
        fi
        if [ -f "ruleset/Surge(Shadowkroket)/GlobalProxy.list" ]; then
          GLOBALPROXY_COUNT=$(grep -cv "^#\|^$" "ruleset/Surge(Shadowkroket)/GlobalProxy.list" 2>/dev/null || echo "0")
          echo "- **GlobalProxy** (å…¨çƒä»£ç†): ${GLOBALPROXY_COUNT} rules" >> $GITHUB_STEP_SUMMARY
        fi
        if [ -f "module/surge(main)/ðŸ”¥ Firewall Port Blocker ðŸ›¡ï¸ðŸš«.sgmodule" ]; then
          FIREWALL_COUNT=$(grep -c "^DEST-PORT\|^IN-PORT\|^SRC-PORT" "module/surge(main)/ðŸ”¥ Firewall Port Blocker ðŸ›¡ï¸ðŸš«.sgmodule" 2>/dev/null || echo "0")
          echo "- **Firewall** (ç«¯å£é˜»æ­¢): ${FIREWALL_COUNT} rules" >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### âš™ï¸ CI/CD Mode" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "âœ… è§„åˆ™é›†æ›´æ–°å’Œåˆå¹¶" >> $GITHUB_STEP_SUMMARY
        echo "âœ… æ™ºèƒ½åŽ»é‡å’Œæ¸…ç†" >> $GITHUB_STEP_SUMMARY
        echo "âœ… ç«¯å£è§„åˆ™åŒæ­¥åˆ°é˜²ç«å¢™æ¨¡å—" >> $GITHUB_STEP_SUMMARY
        echo "âœ… SRS æ–‡ä»¶ç”Ÿæˆ" >> $GITHUB_STEP_SUMMARY
        echo "âœ… Git æäº¤å’ŒæŽ¨é€" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "âŒ è·³è¿‡å¤‡ä»½ (CI=true)" >> $GITHUB_STEP_SUMMARY
        echo "âŒ è·³è¿‡æ ¸å¿ƒæ›´æ–° (--unattended)" >> $GITHUB_STEP_SUMMARY
        echo "âŒ è·³è¿‡ iCloud åŒæ­¥ (--unattended)" >> $GITHUB_STEP_SUMMARY
        echo "âŒ è·³è¿‡ Surge é…ç½®åŒæ­¥ (--unattended)" >> $GITHUB_STEP_SUMMARY
