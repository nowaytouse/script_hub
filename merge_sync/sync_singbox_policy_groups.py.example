#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Singbox Policy Group Sync Script
Function: Sync policy groups from Surge config to Singbox config
Created: 2025-12-07
Updated: 2025-12-07 - Added argparse support
"""

import argparse
import json
import os
import re
import sys

def parse_surge_policy_groups(surge_config_path):
    """Parse policy groups from Surge config file"""
    policy_groups = {}
    
    with open(surge_config_path, 'r', encoding='utf-8') as f:
        lines = f.readlines()
    
    in_proxy_group = False
    
    for line in lines:
        line = line.strip()
        
        # Detect [Proxy Group] section
        if line == '[Proxy Group]':
            in_proxy_group = True
            continue
        
        # Detect other section start
        if line.startswith('[') and line != '[Proxy Group]':
            in_proxy_group = False
            continue
        
        # Skip empty lines and comments
        if not in_proxy_group or not line or line.startswith('#'):
            continue
        
        # Parse policy group definition
        if '=' in line:
            parts = line.split('=', 1)
            if len(parts) == 2:
                group_name = parts[0].strip()
                config = parts[1].strip()
                
                # Detect policy group type
                for group_type in ['select', 'url-test', 'fallback', 'load-balance', 'smart']:
                    if config.startswith(group_type):
                        policy_groups[group_name] = group_type
                        break
    
    return policy_groups

def create_singbox_outbound(name, group_type, default_outbound="Direct"):
    """Create Singbox outbound config"""
    
    # Map Surge type to Singbox type
    type_mapping = {
        'select': 'selector',
        'url-test': 'urltest',
        'fallback': 'urltest',
        'load-balance': 'urltest',
        'smart': 'urltest'
    }
    
    singbox_type = type_mapping.get(group_type, 'selector')
    
    outbound = {
        "type": singbox_type,
        "tag": name,
        "outbounds": [default_outbound]
    }
    
    # Add test parameters for urltest type
    if singbox_type == 'urltest':
        outbound.update({
            "url": "http://www.cloudflare.com/generate_204",
            "interval": "3m",
            "tolerance": 30
        })
    else:
        outbound["default"] = default_outbound
    
    return outbound

def sync_policy_groups(surge_config_path, singbox_config_path, output_path=None, dry_run=False):
    """Sync policy groups"""
    
    print("Reading Surge config...")
    surge_groups = parse_surge_policy_groups(surge_config_path)
    print(f"   Found {len(surge_groups)} Surge policy groups")
    
    print("\nReading Singbox config...")
    with open(singbox_config_path, 'r', encoding='utf-8') as f:
        singbox_config = json.load(f)
    
    # Extract existing Singbox policy groups
    existing_groups = {}
    for outbound in singbox_config.get('outbounds', []):
        if outbound.get('type') in ['selector', 'urltest']:
            existing_groups[outbound['tag']] = outbound
    
    print(f"   Found {len(existing_groups)} Singbox policy groups")
    
    # Find missing policy groups
    missing_groups = []
    for name, group_type in surge_groups.items():
        if name not in existing_groups:
            missing_groups.append((name, group_type))
    
    if not missing_groups:
        print("\nAll policy groups are synced!")
        return
    
    print(f"\nFound {len(missing_groups)} missing policy groups:")
    for name, group_type in missing_groups:
        print(f"   - {name} ({group_type})")
    
    if dry_run:
        print("\n[DRY-RUN] Simulation mode, no files will be modified")
        print("   The following policy groups would be added:")
        for name, group_type in missing_groups:
            print(f"   + {name} ({group_type})")
        return
    
    # Add missing policy groups
    print("\nAdding missing policy groups...")
    for name, group_type in missing_groups:
        new_outbound = create_singbox_outbound(name, group_type)
        singbox_config['outbounds'].append(new_outbound)
        print(f"   Added: {name}")
    
    # Save config
    output_file = output_path or singbox_config_path
    print(f"\nSaving config to: {output_file}")
    with open(output_file, 'w', encoding='utf-8') as f:
        json.dump(singbox_config, f, ensure_ascii=False, indent=2)
    
    print("\nPolicy group sync completed!")
    print(f"   Total policy groups: {len(singbox_config['outbounds'])}")

def get_script_dir():
    """Get script directory"""
    return os.path.dirname(os.path.abspath(__file__))

def get_default_paths():
    """Get default config file paths"""
    script_dir = get_script_dir()
    repo_root = os.path.dirname(script_dir)
    
    # ============================================
    # CONFIGURATION - EDIT THESE PATHS
    # ============================================
    # Surge config - read from iCloud (contains [Proxy Group])
    surge_config = os.path.expanduser(
        "~/Library/Mobile Documents/iCloud~com~nssurge~inc/Documents/YOUR_PROFILE.conf"
    )
    
    # If iCloud config doesn't exist, try local template
    if not os.path.exists(surge_config):
        surge_config = os.path.join(repo_root, "ruleset/Sources/conf/surge_profile_template.conf")
    
    # Singbox template
    singbox_config = os.path.join(repo_root, "substore/Singbox_substore_1.13.0+.json")
    
    return surge_config, singbox_config

if __name__ == '__main__':
    default_surge, default_singbox = get_default_paths()
    
    parser = argparse.ArgumentParser(
        description='Sync policy groups from Surge config to Singbox config',
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog='''
Examples:
  %(prog)s                           # Use default paths
  %(prog)s --dry-run                 # Simulation mode, no file changes
  %(prog)s -s surge.conf -b box.json # Specify config files
  %(prog)s --surge surge.conf        # Only specify Surge config
        '''
    )
    
    parser.add_argument('-s', '--surge', 
                        default=default_surge,
                        help=f'Surge config file path (default: {default_surge})')
    parser.add_argument('-b', '--singbox',
                        default=default_singbox,
                        help=f'Singbox config file path (default: {default_singbox})')
    parser.add_argument('-o', '--output',
                        help='Output file path (default: overwrite Singbox config)')
    parser.add_argument('-n', '--dry-run',
                        action='store_true',
                        help='Simulation mode, no file changes')
    parser.add_argument('-v', '--verbose',
                        action='store_true',
                        help='Show verbose information')
    
    args = parser.parse_args()
    
    # Check if files exist
    if not os.path.exists(args.surge):
        print(f"Error: Surge config file not found: {args.surge}", file=sys.stderr)
        print("Please edit the default paths in this script", file=sys.stderr)
        sys.exit(1)
    
    if not os.path.exists(args.singbox):
        print(f"Error: Singbox config file not found: {args.singbox}", file=sys.stderr)
        sys.exit(1)
    
    if args.verbose:
        print(f"Surge config: {args.surge}")
        print(f"Singbox config: {args.singbox}")
        if args.output:
            print(f"Output file: {args.output}")
        if args.dry_run:
            print("Mode: DRY-RUN (no file changes)")
        print()
    
    try:
        sync_policy_groups(args.surge, args.singbox, args.output, args.dry_run)
    except Exception as e:
        print(f"\nError: {e}", file=sys.stderr)
        sys.exit(1)
