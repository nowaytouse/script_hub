#!/usr/bin/env bash
# =============================================================================
# Sync Config to All Proxy Apps
# Function: Sync template config to Surge and Shadowrocket actual config files
# =============================================================================

set -e

GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
RED='\033[0;31m'
NC='\033[0m'

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"

log_info() { echo -e "${BLUE}[INFO]${NC} $1"; }
log_success() { echo -e "${GREEN}[OK]${NC} $1"; }
log_warning() { echo -e "${YELLOW}[WARN]${NC} $1"; }
log_error() { echo -e "${RED}[ERROR]${NC} $1"; }

# ============================================
# CONFIGURATION - EDIT THESE PATHS
# ============================================
SURGE_TEMPLATE="$PROJECT_ROOT/conf_template/surge_profile_template.conf"
SURGE_ICLOUD="$HOME/Library/Mobile Documents/iCloud~com~nssurge~inc/Documents/YOUR_PROFILE.conf"
SHADOWROCKET_ICLOUD="$HOME/Library/Mobile Documents/iCloud~com~liguangming~Shadowrocket/Documents"

echo -e "${BLUE}+--------------------------------------------------------------+${NC}"
echo -e "${BLUE}|           Sync Config to All Proxy Apps                      |${NC}"
echo -e "${BLUE}+--------------------------------------------------------------+${NC}"
echo ""

# 1. Sync to Surge iCloud
log_info "Syncing to Surge iCloud config..."
if [ -f "$SURGE_ICLOUD" ]; then
    # Backup original config
    cp "$SURGE_ICLOUD" "$SURGE_ICLOUD.backup.$(date +%Y%m%d_%H%M%S)"
    log_info "Backed up original config"
    
    log_info "Updating rules section..."
    
    # Use Python script to update rules
    python3 - "$SURGE_TEMPLATE" "$SURGE_ICLOUD" <<'PYTHON_SCRIPT'
import sys
import re

template_file = sys.argv[1]
target_file = sys.argv[2]

# Read template
with open(template_file, 'r', encoding='utf-8') as f:
    template = f.read()

# Read target file
with open(target_file, 'r', encoding='utf-8') as f:
    target = f.read()

# Extract [Rule] section from template
rule_match = re.search(r'\[Rule\](.*?)(?=\[|$)', template, re.DOTALL)
if rule_match:
    template_rules = rule_match.group(0)
    
    # Replace [Rule] section in target file
    target = re.sub(r'\[Rule\].*?(?=\[|$)', template_rules, target, flags=re.DOTALL)
    
    with open(target_file, 'w', encoding='utf-8') as f:
        f.write(target)
    
    print(f"Rules updated: {target_file}")
else:
    print("[Rule] section not found")
    sys.exit(1)
PYTHON_SCRIPT
    
    log_success "Surge iCloud config updated"
else
    log_warning "Surge iCloud config not found: $SURGE_ICLOUD"
    log_info "Please edit SURGE_ICLOUD in this script"
fi

# 2. Sync modules to Shadowrocket
log_info "Syncing modules to Shadowrocket..."
if [ -d "$SHADOWROCKET_ICLOUD" ]; then
    # Copy firewall module
    FIREWALL_MODULE="$PROJECT_ROOT/module/surge(main)/Firewall Port Blocker.sgmodule"
    if [ -f "$FIREWALL_MODULE" ]; then
        cp "$FIREWALL_MODULE" "$SHADOWROCKET_ICLOUD/"
        log_success "Firewall module synced to Shadowrocket"
    fi
    
    # Copy other modules
    for module in "$PROJECT_ROOT/module/surge(main)"/*.sgmodule; do
        if [ -f "$module" ]; then
            cp "$module" "$SHADOWROCKET_ICLOUD/"
            log_info "Copied: $(basename "$module")"
        fi
    done
    
    log_success "Shadowrocket modules synced"
else
    log_warning "Shadowrocket iCloud directory not found: $SHADOWROCKET_ICLOUD"
fi

echo ""
log_success "All config sync completed!"
echo ""
echo -e "${BLUE}Sync Results:${NC}"
echo "   - Surge iCloud: Rules updated"
echo "   - Shadowrocket modules: Synced"
